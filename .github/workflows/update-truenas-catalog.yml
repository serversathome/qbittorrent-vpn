name: Update TrueNAS Catalog

on:
  workflow_run:
    workflows: ["Rebuild on Base Image Update"]
    types:
      - completed
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  update-catalog:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout qbittorrent-wireguard repo
        uses: actions/checkout@v4

      - name: Get qBittorrent version from base image
        id: get_version
        run: |
          echo "Fetching version from linuxserver/qbittorrent:latest"

          # Get the version label from the linuxserver.io image
          FULL_VERSION=$(skopeo inspect docker://linuxserver/qbittorrent:latest | \
            jq -r '.Labels["org.opencontainers.image.version"]')

          if [ -z "$FULL_VERSION" ] || [ "$FULL_VERSION" = "null" ]; then
            echo "Could not extract version from base image"
            exit 1
          fi

          echo "Full version string: $FULL_VERSION"

          # Extract just the qBittorrent version (e.g., "5.1.4" from "5.1.4-r1-ls431")
          VERSION=$(echo "$FULL_VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+\.[0-9]+).*/\1/')

          if [ -z "$VERSION" ]; then
            echo "Could not parse version from: $FULL_VERSION"
            exit 1
          fi

          echo "Extracted qBittorrent version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Checkout TrueNAS apps fork
        uses: actions/checkout@v4
        with:
          repository: serversathome/apps
          token: ${{ secrets.APPS_REPO_TOKEN }}
          path: apps-repo

      - name: Update app.yaml version
        id: update_version
        run: |
          APP_YAML="apps-repo/ix-dev/community/qbittorrent-wireguard/app.yaml"
          NEW_VERSION="${{ steps.get_version.outputs.version }}"

          if [ ! -f "$APP_YAML" ]; then
            echo "Error: app.yaml not found at $APP_YAML"
            exit 1
          fi

          # Get current version
          CURRENT_VERSION=$(grep '^version:' "$APP_YAML" | awk '{print $2}')
          echo "Current version: $CURRENT_VERSION"
          echo "New version: $NEW_VERSION"

          # Check if update is needed
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "Version already up to date, no changes needed"
            echo "needs_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Update the version field in app.yaml
          sed -i "s/^version:.*/version: $NEW_VERSION/" "$APP_YAML"

          # Verify the change
          NEW_VERSION_CHECK=$(grep '^version:' "$APP_YAML" | awk '{print $2}')
          if [ "$NEW_VERSION_CHECK" != "$NEW_VERSION" ]; then
            echo "Error: Version update failed"
            exit 1
          fi

          echo "Successfully updated version from $CURRENT_VERSION to $NEW_VERSION"
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "old_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.update_version.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.APPS_REPO_TOKEN }}
          path: apps-repo
          commit-message: "chore(qbittorrent-wireguard): update to version ${{ steps.get_version.outputs.version }}"
          branch: update-qbittorrent-wireguard-${{ steps.get_version.outputs.version }}
          delete-branch: true
          title: "Update qBittorrent-WireGuard to version ${{ steps.get_version.outputs.version }}"
          body: |
            ## Updates qBittorrent-WireGuard app

            This automated PR updates the qBittorrent-WireGuard app to match the latest base image version.

            **Changes:**
            - Updated version from `${{ steps.update_version.outputs.old_version }}` to `${{ steps.get_version.outputs.version }}`
            - Base image: `linuxserver/qbittorrent:latest` (qBittorrent ${{ steps.get_version.outputs.version }})

            **Docker Image:**
            - `serversathome/qbittorrent-wireguard:latest`

            This PR was automatically generated by the [update-truenas-catalog workflow](https://github.com/serversathome/qbittorrent-wireguard/actions/workflows/update-truenas-catalog.yml).
          labels: |
            automated
            qbittorrent-wireguard
          base: master
          push-to-fork: serversathome/apps

      - name: Summary
        if: steps.update_version.outputs.needs_update == 'true'
        run: |
          echo "âœ… Successfully created PR to update qBittorrent-WireGuard to version ${{ steps.get_version.outputs.version }}"
          echo "ğŸ“¦ Docker image: serversathome/qbittorrent-wireguard:latest"
          echo "ğŸ”„ Base image version: linuxserver/qbittorrent:latest (qBittorrent ${{ steps.get_version.outputs.version }})"

      - name: No update needed
        if: steps.update_version.outputs.needs_update == 'false'
        run: |
          echo "â„¹ï¸ TrueNAS catalog is already up to date with version ${{ steps.get_version.outputs.version }}"
